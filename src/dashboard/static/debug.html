<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Titan Dashboard</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3ET%3C/text%3E%3C/svg%3E"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b0d12;
        --panel: rgba(18, 22, 30, 0.72);
        --accent: #4aa3ff;
        --accent-soft: rgba(74, 163, 255, 0.2);
        --up: #00b894;
        --down: #d63031;
        --text: #e6edf3;
        --muted: #8b97a3;
        --border: rgba(255, 255, 255, 0.06);
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Outfit", sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .glass-panel {
        background: var(--panel);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 24px;
        margin: 16px;
      }

      .logo {
        font-size: 1.35rem;
        font-weight: 600;
        background: linear-gradient(45deg, #7cc7ff, #3b6cff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 0.8rem;
        letter-spacing: 0.6px;
        text-transform: uppercase;
        border: 1px solid var(--border);
        background: rgba(0, 184, 148, 0.15);
        color: var(--up);
      }

      .status-badge.warn {
        background: rgba(214, 48, 49, 0.15);
        color: var(--down);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--up);
        box-shadow: 0 0 8px rgba(0, 184, 148, 0.6);
      }

      .status-badge.warn .status-dot {
        background: var(--down);
        box-shadow: 0 0 8px rgba(214, 48, 49, 0.6);
      }

      .main-container {
        flex: 1;
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
        gap: 16px;
        padding: 0 16px 16px;
        min-height: 0;
      }

      .panel {
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .panel-title {
        padding: 16px 20px 8px;
        font-size: 0.75rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--muted);
      }

      .panel-body {
        padding: 0 20px 20px;
        flex: 1;
        min-height: 0;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .chart-card {
        position: relative;
        height: 260px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        margin-bottom: 16px;
        overflow: hidden;
      }

      .chart-card canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .chart-empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 0.9rem;
        background: rgba(0, 0, 0, 0.3);
      }

      .stat-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.02);
      }

      .stat-label {
        font-size: 0.7rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 6px;
      }

      .stat-sub {
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .info-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.02);
      }

      .info-title {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .info-body {
        margin-top: 8px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.78rem;
        white-space: pre-wrap;
        word-break: break-word;
        color: #c9d4dd;
      }

      .events-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
      }

      .events-table th,
      .events-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 6px 8px;
        text-align: left;
      }

      .events-table th {
        color: var(--muted);
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.7rem;
      }

      .section {
        margin-bottom: 18px;
      }

      .section-title {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
      }

      .metrics-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
      }

      .metrics-table td,
      .metrics-table th {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 6px 8px;
        text-align: left;
      }

      .metrics-table th {
        color: var(--muted);
        font-weight: 400;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.7rem;
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
      }

      .pill.up {
        color: var(--up);
        background: rgba(0, 184, 148, 0.15);
      }

      .pill.down {
        color: var(--down);
        background: rgba(214, 48, 49, 0.15);
      }

      .config-form label {
        display: block;
        font-size: 0.7rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
      }

      .config-form input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        margin-top: 6px;
        font-family: inherit;
      }

      .config-form button {
        margin-top: 12px;
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: var(--accent);
        color: #0b0d12;
        font-weight: 600;
        cursor: pointer;
      }

      .config-result {
        margin-top: 10px;
        font-size: 0.75rem;
        color: var(--muted);
        white-space: pre-wrap;
      }

      .muted {
        color: var(--muted);
      }

      @media (max-width: 1100px) {
        .main-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="header glass-panel">
      <div class="logo">Titan Dashboard</div>
      <div class="status-badge" id="status-badge">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Connecting</span>
      </div>
    </header>

    <main class="main-container">
      <section class="panel glass-panel">
        <div class="panel-title">Market Stream</div>
        <div class="panel-body">
          <div class="chart-card">
            <canvas id="price-chart"></canvas>
            <div class="chart-empty" id="chart-empty">Waiting for candles...</div>
          </div>
          <div class="stat-grid">
            <div class="stat-card">
              <div class="stat-label">Last Price</div>
              <div class="stat-value" id="price">-</div>
              <div class="stat-sub" id="price-meta">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Last Move</div>
              <div class="stat-value" id="last-move">-</div>
              <div class="stat-sub" id="last-move-meta">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Volume</div>
              <div class="stat-value" id="volume">-</div>
              <div class="stat-sub" id="volume-meta">-</div>
            </div>
          </div>

          <div class="card-grid">
            <div class="info-card">
              <div class="info-title">Latest Candle</div>
              <div class="info-body" id="latest-candle">-</div>
            </div>
            <div class="info-card">
              <div class="info-title">Latest Prediction</div>
              <div class="info-body" id="latest-pred">-</div>
            </div>
            <div class="info-card">
              <div class="info-title">Latest Fact</div>
              <div class="info-body" id="latest-fact">-</div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Recent Events</div>
            <table class="events-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Summary</th>
                </tr>
              </thead>
              <tbody id="events-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel glass-panel">
        <div class="panel-title">Metrics & Config</div>
        <div class="panel-body">
          <div class="section">
            <div class="section-title">Metrics</div>
            <table class="metrics-table">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody id="metrics-body"></tbody>
            </table>
          </div>

          <div class="section">
            <div class="section-title">Model</div>
            <table class="metrics-table">
              <thead>
                <tr>
                  <th>Field</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody id="model-body"></tbody>
            </table>
          </div>

          <div class="section">
            <div class="section-title">Live Config</div>
            <form id="config-form" class="config-form">
              <label for="flat_max_prob">flat_max_prob</label>
              <input type="number" step="0.01" id="flat_max_prob" />
              <label for="flat_max_delta">flat_max_delta</label>
              <input type="number" step="0.01" id="flat_max_delta" />
              <label for="learning_rate">learning_rate</label>
              <input type="number" step="0.0001" id="learning_rate" />
              <label for="flat_bps">flat_bps</label>
              <input type="number" step="0.1" id="flat_bps" />
              <label for="lookback">lookback (requires restart)</label>
              <input type="number" step="1" id="lookback" />
              <button type="submit">Update Config</button>
            </form>
            <div class="config-result" id="config-result"></div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const eventsBody = document.getElementById("events-body");
      const metricsBody = document.getElementById("metrics-body");
      const modelBody = document.getElementById("model-body");
      const candleEl = document.getElementById("latest-candle");
      const predEl = document.getElementById("latest-pred");
      const factEl = document.getElementById("latest-fact");
      const statusBadge = document.getElementById("status-badge");
      const statusText = document.getElementById("status-text");
      const priceEl = document.getElementById("price");
      const priceMetaEl = document.getElementById("price-meta");
      const lastMoveEl = document.getElementById("last-move");
      const lastMoveMetaEl = document.getElementById("last-move-meta");
      const volumeEl = document.getElementById("volume");
      const volumeMetaEl = document.getElementById("volume-meta");
      const configResult = document.getElementById("config-result");
      const chartCanvas = document.getElementById("price-chart");
      const chartEmpty = document.getElementById("chart-empty");
      const chartCtx = chartCanvas.getContext("2d");
      const priceHistory = [];
      const MAX_POINTS = 240;
      const uiState = {
        latest_candle: null,
        latest_prediction: null,
        latest_fact: null,
        metrics: {},
        ws: {},
        recent_events: [],
      };

      const formatObj = (obj) => {
        if (obj === null || obj === undefined) return "-";
        return JSON.stringify(
          obj,
          (key, value) => {
            if (
              typeof value === "number" &&
              (key.endsWith("_ts") || key.startsWith("ts_") || key === "ts")
            ) {
              return `${value} (${formatTs(value)})`;
            }
            return value;
          },
          0
        );
      };

      const formatNum = (value, digits = 4) => {
        if (value === null || value === undefined || Number.isNaN(value)) return "-";
        return Number(value).toFixed(digits);
      };

      const formatTs = (ts) => {
        if (!ts) return "-";
        const date = new Date(ts);
        if (Number.isNaN(date.getTime())) return "-";
        const pad = (value) => String(value).padStart(2, "0");
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(
          date.getDate()
        )} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(
          date.getSeconds()
        )}`;
      };

      function updateStatus(ws) {
        const connected = ws && ws.connected;
        if (connected) {
          statusBadge.classList.remove("warn");
          statusText.textContent = "Live";
        } else {
          statusBadge.classList.add("warn");
          statusText.textContent = "Offline";
        }
      }

      function resizeChart() {
        const parent = chartCanvas.parentElement;
        if (!parent) return;
        const rect = parent.getBoundingClientRect();
        chartCanvas.width = Math.max(1, Math.floor(rect.width));
        chartCanvas.height = Math.max(1, Math.floor(rect.height));
        drawChart();
      }

      function drawChart() {
        const ctx = chartCtx;
        const width = chartCanvas.width;
        const height = chartCanvas.height;
        ctx.clearRect(0, 0, width, height);

        if (priceHistory.length < 2) {
          chartEmpty.style.display = "flex";
          return;
        }
        chartEmpty.style.display = "none";

        const padding = 16;
        const values = priceHistory.map((p) => p.close);
        const min = Math.min(...values);
        const max = Math.max(...values);
        const span = max - min || 1;
        const innerW = width - padding * 2;
        const innerH = height - padding * 2;

        ctx.strokeStyle = "rgba(74, 163, 255, 0.9)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        priceHistory.forEach((point, idx) => {
          const x = padding + (idx / (priceHistory.length - 1)) * innerW;
          const y = padding + innerH - ((point.close - min) / span) * innerH;
          if (idx === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        const last = priceHistory[priceHistory.length - 1];
        ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
        ctx.font = "12px Outfit, sans-serif";
        ctx.fillText(`Last ${formatNum(last.close, 2)}`, padding, padding - 4);
      }

      function rebuildHistory(events) {
        const candles = events
          .filter((e) => e.type === "candle" && e.data)
          .map((e) => ({ ts: e.data.ts_start, close: e.data.c }))
          .filter((e) => typeof e.ts === "number" && typeof e.close === "number")
          .sort((a, b) => a.ts - b.ts);

        priceHistory.length = 0;
        candles.slice(-MAX_POINTS).forEach((item) => priceHistory.push(item));
        drawChart();
      }

      function updateHistoryFromCandle(candle) {
        if (!candle || typeof candle.ts_start !== "number" || typeof candle.c !== "number") return;
        const last = priceHistory[priceHistory.length - 1];
        if (last && last.ts === candle.ts_start) {
          last.close = candle.c;
        } else {
          priceHistory.push({ ts: candle.ts_start, close: candle.c });
          if (priceHistory.length > MAX_POINTS) priceHistory.shift();
        }
        drawChart();
      }

      function updateMarket(state) {
        const candle = state.latest_candle;
        const fact = state.latest_fact;
        if (candle) {
          priceEl.textContent = formatNum(candle.c, 2);
          priceMetaEl.textContent = `O ${formatNum(candle.o, 2)} H ${formatNum(candle.h, 2)} L ${formatNum(candle.l, 2)}`;
          volumeEl.textContent = formatNum(candle.volume, 4);
          volumeMetaEl.textContent = `Confirmed ${String(candle.confirmed)} | ${formatTs(candle.ts_start)}`;
        } else {
          priceEl.textContent = "-";
          priceMetaEl.textContent = "-";
          volumeEl.textContent = "-";
          volumeMetaEl.textContent = "-";
        }

        if (fact) {
          const bps = formatNum(fact.ret_bps, 2);
          const dir = fact.direction || "-";
          lastMoveEl.textContent = `${dir} ${bps} bps`;
          lastMoveMetaEl.textContent = `${formatNum(fact.close_prev, 2)} -> ${formatNum(fact.close_curr, 2)}`;
        } else {
          lastMoveEl.textContent = "-";
          lastMoveMetaEl.textContent = "-";
        }
      }

      function renderMetrics(metrics) {
        const rows = [
          ["total", metrics.total],
          ["accuracy", metrics.accuracy],
          ["accuracy_nonflat", metrics.accuracy_nonflat],
          ["flat_rate", metrics.flat_rate],
          ["avg_reward", metrics.avg_reward],
          ["avg_loss", metrics.avg_loss],
          ["calibration_ece", metrics.calibration_ece],
          ["calibration_mce", metrics.calibration_mce],
          ["confidence_ret_bps_corr", metrics.confidence_ret_bps_corr],
          ["window_accuracy", metrics.window_accuracy],
          ["window_avg_reward", metrics.window_avg_reward],
          ["window_confidence_ret_bps_corr", metrics.window_confidence_ret_bps_corr],
        ];
        metricsBody.innerHTML = rows
          .map(([label, value]) => {
            const formatted = typeof value === "number" ? formatNum(value, 4) : formatObj(value);
            return `<tr><td>${label}</td><td>${formatted}</td></tr>`;
          })
          .join("");
      }

      function renderModel(model) {
        if (!model) {
          modelBody.innerHTML = "<tr><td colspan=\"2\">-</td></tr>";
          return;
        }
        const rows = [
          ["model_id", model.model_id],
          ["interval", model.interval],
          ["updates", model.updates],
          ["learning_rate", model.learning_rate],
          ["accuracy", model.accuracy],
          ["last_reward", model.last_reward],
          ["last_loss", model.last_loss],
          ["update_interval_ms", model.update_interval_ms],
          ["updates_per_min", model.updates_per_min],
          ["w_up", model.weight_norms ? model.weight_norms.w_up : null],
          ["w_down", model.weight_norms ? model.weight_norms.w_down : null],
        ];
        modelBody.innerHTML = rows
          .map(([label, value]) => {
            const formatted = typeof value === "number" ? formatNum(value, 4) : value ?? "-";
            return `<tr><td>${label}</td><td>${formatted}</td></tr>`;
          })
          .join("");
      }

      function addEventRow(event) {
        const row = document.createElement("tr");
        const typeCell = document.createElement("td");
        typeCell.textContent = event.type;
        const summaryCell = document.createElement("td");
        summaryCell.textContent = formatObj(event.data);
        row.appendChild(typeCell);
        row.appendChild(summaryCell);
        eventsBody.prepend(row);
        while (eventsBody.childElementCount > 25) {
          eventsBody.removeChild(eventsBody.lastChild);
        }
      }

      function renderEvents(events) {
        eventsBody.innerHTML = "";
        events.slice(0, 25).forEach((event) => {
          const row = document.createElement("tr");
          const typeCell = document.createElement("td");
          typeCell.textContent = event.type;
          const summaryCell = document.createElement("td");
          summaryCell.textContent = formatObj(event.data);
          row.appendChild(typeCell);
          row.appendChild(summaryCell);
          eventsBody.appendChild(row);
        });
      }

      async function refreshState() {
        const res = await fetch("/api/state");
        const state = await res.json();
        uiState.latest_candle = state.latest_candle || null;
        uiState.latest_prediction = state.latest_prediction || null;
        uiState.latest_fact = state.latest_fact || null;
        uiState.metrics = state.metrics || {};
        uiState.ws = state.ws || {};
        uiState.recent_events = Array.isArray(state.recent_events) ? state.recent_events : [];

        updateStatus(uiState.ws);
        updateMarket(uiState);
        candleEl.textContent = formatObj(uiState.latest_candle);
        predEl.textContent = formatObj(uiState.latest_prediction);
        factEl.textContent = formatObj(uiState.latest_fact);
        renderMetrics(uiState.metrics);
        renderEvents(uiState.recent_events);
        rebuildHistory(uiState.recent_events);
      }

      async function refreshModels() {
        const res = await fetch("/api/models");
        const data = await res.json();
        renderModel(data.models && data.models.length > 0 ? data.models[0] : null);
      }

      const es = new EventSource("/api/stream");
      es.onmessage = (evt) => {
        const event = JSON.parse(evt.data);
        uiState.recent_events.unshift(event);
        if (uiState.recent_events.length > 50) {
          uiState.recent_events.length = 50;
        }
        addEventRow(event);
        if (event.type === "metrics") {
          uiState.metrics = event.data || {};
          renderMetrics(uiState.metrics);
        }
        if (event.type === "prediction") {
          uiState.latest_prediction = event.data || null;
          predEl.textContent = formatObj(uiState.latest_prediction);
        }
        if (event.type === "fact") {
          uiState.latest_fact = event.data || null;
          factEl.textContent = formatObj(uiState.latest_fact);
          updateMarket(uiState);
        }
        if (event.type === "candle") {
          uiState.latest_candle = event.data || null;
          candleEl.textContent = formatObj(uiState.latest_candle);
          updateMarket(uiState);
          updateHistoryFromCandle(uiState.latest_candle);
        }
        if (event.type === "ws_status") {
          uiState.ws = event.data || {};
          updateStatus(uiState.ws);
        }
      };

      document.getElementById("config-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
          flat_max_prob: parseFloat(document.getElementById("flat_max_prob").value),
          flat_max_delta: parseFloat(document.getElementById("flat_max_delta").value),
          learning_rate: parseFloat(document.getElementById("learning_rate").value),
          flat_bps: parseFloat(document.getElementById("flat_bps").value),
          lookback: parseInt(document.getElementById("lookback").value, 10),
        };

        Object.keys(payload).forEach((key) => {
          if (Number.isNaN(payload[key])) {
            delete payload[key];
          }
        });

        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const result = await res.json();
        configResult.textContent = JSON.stringify(result, null, 2);
      });

      refreshState();
      refreshModels();
      new ResizeObserver(resizeChart).observe(chartCanvas.parentElement);
      resizeChart();
      setInterval(refreshState, 5000);
      setInterval(refreshModels, 15000);
    </script>
  </body>
</html>
