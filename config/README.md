# Калибровочные конфигурации

Эта директория содержит JSON конфигурации для настройки адаптивной системы калибровки моделей.

## Структура конфига

```json
{
  "global": {
    // Общие параметры калибровки для всех моделей
  },
  "per_model": {
    "TRENDVIC": { /* настройки для TRENDVIC */ },
    "OSCILLATOR": { /* настройки для OSCILLATOR */ },
    "VOLUMEMETRIX": { /* настройки для VOLUMEMETRIX */ }
  }
}
```

## Доступные файлы

### `calibration_default.json`
**Назначение**: Базовая конфигурация с дефолтными параметрами адаптивной системы.

**Когда использовать**:
- Для первого запуска с адаптивной калибровкой
- Когда нужно протестировать систему без специальных настроек

**Команда**:
```bash
.venv/bin/python -m src.offline_replay \
  --symbol BTCUSDT --tf 1 --minutes 240 \
  --mode train \
  --fact-flat-mode adaptive \
  --pred-flat-mode adaptive \
  --reward-mode shaped \
  --run-dir runs/test_default \
  --calib-config config/calibration_default.json
```

### `calibration_example.json`
**Назначение**: Пример конфигурации с индивидуальными настройками для каждой модели.

**Особенности**:
- TRENDVIC: минимальные настройки (уже хорошо откалиброван)
- OSCILLATOR: средние корректировки для переуверенности
- VOLUMEMETRIX: умеренные корректировки

**Когда использовать**: Как отправная точка для создания собственных конфигов.

### `oscillator_aggressive.json`
**Назначение**: Агрессивная конфигурация для решения проблемы коллапса параметров OSCILLATOR.

**Проблема**:
- OSCILLATOR имеет `calib_a` застрявший на 0.300 (минимум)
- ECE = 0.515 (серьёзная переуверенность)
- 43% уверенных предсказаний неправильны

**Решение**:
- Более широкие границы параметров (`a_min=0.15`, `a_max=3.5`)
- Повышенный learning rate (`lr=0.01`, `lr_max=0.05`)
- Более ленивые ECE пороги
- Начальное значение `init_a=0.50` вместо 1.0

**Команда**:
```bash
.venv/bin/python -m src.offline_replay \
  --symbol BTCUSDT --tf 1 --minutes 240 \
  --mode train \
  --fact-flat-mode adaptive \
  --pred-flat-mode adaptive \
  --reward-mode shaped \
  --run-dir runs/oscillator_fix \
  --calib-config config/oscillator_aggressive.json
```

## Глобальные параметры

### Базовая калибровка
| Параметр | Дефолт | Описание |
|----------|--------|----------|
| `calib_lr` | 0.005 | Базовый learning rate для SGD |
| `calib_a_min` | 0.30 | Минимум для параметра `a` (scale) |
| `calib_a_max` | 2.0 | Максимум для параметра `a` |
| `calib_b_min` | -1.0 | Минимум для параметра `b` (bias) |
| `calib_b_max` | 1.0 | Максимум для параметра `b` |
| `calib_l2_a` | 0.01 | L2 регуляризация для `a` |
| `calib_l2_b` | 0.001 | L2 регуляризация для `b` |

### Адаптивный learning rate
| Параметр | Дефолт | Описание |
|----------|--------|----------|
| `calib_lr_min` | 0.0001 | Минимальный lr |
| `calib_lr_max` | 0.02 | Максимальный lr |
| `calib_ece_target` | 0.05 | Целевой ECE |
| `calib_ece_good_threshold` | 0.10 | ECE ниже этого - хорошо |
| `calib_ece_bad_threshold` | 0.25 | ECE выше этого - плохо |
| `calib_lr_increase_factor` | 1.5 | Множитель увеличения lr |
| `calib_lr_decrease_factor` | 0.9 | Множитель уменьшения lr |
| `calib_adaptation_interval` | 20 | Интервал между адаптациями |
| `calib_min_samples_for_adaptation` | 30 | Минимум ECE сэмплов |
| `calib_ece_window_size` | 50 | Размер окна для ECE |

## Per-model параметры

Любой из глобальных параметров может быть переопределён для конкретной модели:

```json
{
  "per_model": {
    "OSCILLATOR": {
      "lr": 0.010,           // Переопределить базовый lr
      "a_min": 0.15,         // Расширить нижнюю границу
      "a_max": 3.5,          // Расширить верхнюю границу
      "lr_max": 0.05,        // Разрешить более агрессивную адаптацию
      "ece_target": 0.10,    // Более ленивая цель
      "init_a": 0.50,        // Начальное значение параметра a
      "init_b": 0.0          // Начальное значение параметра b
    }
  }
}
```

## Как работает адаптивная система

1. **Обновление параметров**: После каждого факта SGD обновляет `a` и `b`
2. **Отслеживание ECE**: Система считает ECE по скользящему окну (50 сэмплов)
3. **Адаптация lr**: Каждые 20 обновлений:
   - Если `ECE > 0.25` (плохо) → `lr *= 1.5` (ускориться)
   - Если `ECE < 0.10` (хорошо) → `lr *= 0.9` (замедлиться)
   - Если `0.10 ≤ ECE ≤ 0.25` → проверить тренд, мягкая корректировка
4. **Границы**: `lr` зажат между `calib_lr_min` и `calib_lr_max`

## Создание своего конфига

1. Скопируйте `calibration_example.json`
2. Измените глобальные параметры (опционально)
3. Настройте per-model секцию для проблемных моделей
4. Запустите тест с `--calib-config config/your_config.json`

### Советы

**Для переуверенных моделей** (высокий ECE, высокий confident_wrong):
- Увеличьте `lr` и `lr_max`
- Расширьте `a_min` вниз (позволит сильнее сжимать уверенность)
- Установите `init_a < 1.0` для более агрессивного старта

**Для недоуверенных моделей** (низкий avg_conf):
- Расширьте `a_max` вверх
- Установите `init_a > 1.0`

**Для нестабильных моделей**:
- Увеличьте `calib_adaptation_interval` (медленнее адаптация)
- Увеличьте `calib_ece_window_size` (более сглаженный ECE)

## Мониторинг

После запуска проверьте в логах:
```
INFO Loaded calibration config from: config/oscillator_aggressive.json
INFO Per-model configs: ['OSCILLATOR', 'VOLUMEMETRIX', 'TRENDVIC']
```

В отчёте смотрите:
- `Calibration evolution`: динамика `a` и `b`
- `calibration: ece=...`: целевой показатель
- `confident_wrong_rate`: процент уверенно неправильных

## Комментарии в JSON

Ключи, начинающиеся с `_`, игнорируются парсером и могут использоваться для комментариев:

```json
{
  "_comment": "This is ignored",
  "_note": "So is this",
  "calib_lr": 0.005
}
```
