<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Oracle Patterns</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table thead th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
        .table td { vertical-align: middle; font-size: 0.85rem; }
        .sticky-head thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
        .pattern-id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .badge-status { font-size: 0.7rem; }
        .detail-muted { color: #6c757d; font-size: 0.85rem; }
        .json-box { font-size: 0.75rem; max-height: 240px; overflow: auto; }
        .table-compact td { padding: 0.35rem 0.5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-sitemap me-2"></i><span data-i18n="brand">Pattern Monitor</span></span>
            <div class="d-flex align-items-center gap-2">
                <a class="btn btn-outline-light btn-sm" href="/" data-i18n="nav_dashboard">Dashboard</a>
                <a class="btn btn-outline-light btn-sm" href="/models" data-i18n="nav_models">Models</a>
                <a class="btn btn-outline-light btn-sm" href="/inputs" data-i18n="nav_inputs">Inputs</a>
                <select class="form-select form-select-sm bg-dark text-light border-secondary" id="lang-select" aria-label="Language" style="width: 86px;">
                    <option value="en">EN</option>
                    <option value="ru">RU</option>
                </select>
                <span class="text-light" id="connection-status"><span class="badge bg-success" data-i18n="status_connected">Connected</span></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="text-muted mb-0" data-i18n="title">Patterns Overview</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh" data-i18n="auto_refresh">Auto-refresh (5s)</label>
                    </div>
                </div>
                <div class="detail-muted mt-2" id="list-meta">--</div>
            </div>
        </div>
        <div class="card p-3">
            <div class="row g-2 align-items-end">
                <div class="col-sm-3 col-lg-2">
                    <label class="form-label small text-muted" data-i18n="filter_status">Status</label>
                    <select class="form-select form-select-sm" id="filter-status">
                        <option value="" data-i18n="filter_all">All</option>
                        <option value="active">active</option>
                        <option value="probation">probation</option>
                        <option value="archived">archived</option>
                    </select>
                </div>
                <div class="col-sm-3 col-lg-2">
                    <label class="form-label small text-muted" data-i18n="filter_timeframe">Timeframe</label>
                    <select class="form-select form-select-sm" id="filter-timeframe">
                        <option value="" data-i18n="filter_all">All</option>
                        <option value="1m">1m</option>
                        <option value="5m">5m</option>
                        <option value="10m">10m</option>
                        <option value="15m">15m</option>
                        <option value="30m">30m</option>
                        <option value="60m">60m</option>
                    </select>
                </div>
                <div class="col-sm-3 col-lg-2">
                    <label class="form-label small text-muted" data-i18n="filter_horizon">Horizon</label>
                    <select class="form-select form-select-sm" id="filter-horizon">
                        <option value="" data-i18n="filter_all">All</option>
                    </select>
                </div>
                <div class="col-sm-3 col-lg-2">
                    <label class="form-label small text-muted" data-i18n="filter_contrarian">Contrarian</label>
                    <select class="form-select form-select-sm" id="filter-contrarian">
                        <option value="" data-i18n="filter_all">All</option>
                        <option value="true" data-i18n="yes">Yes</option>
                        <option value="false" data-i18n="no">No</option>
                    </select>
                </div>
                <div class="col-sm-6 col-lg-2">
                    <label class="form-label small text-muted" data-i18n="filter_sort">Sort</label>
                    <select class="form-select form-select-sm" id="filter-sort">
                        <option value="n" data-i18n="sort_n">Samples</option>
                        <option value="credibility" data-i18n="sort_credibility">Credibility</option>
                        <option value="dir_accuracy" data-i18n="sort_dir_acc">Dir Accuracy</option>
                        <option value="last_seen" data-i18n="sort_last_seen">Last Seen</option>
                        <option value="misdirection" data-i18n="sort_misdirection">Misdirection</option>
                        <option value="ring_count" data-i18n="sort_ring">Ring Count</option>
                    </select>
                </div>
                <div class="col-sm-6 col-lg-2">
                    <label class="form-label small text-muted" data-i18n="filter_search">Pattern ID</label>
                    <input class="form-control form-control-sm" id="filter-search" placeholder="abc123...">
                </div>
                <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" id="btn-prev" data-i18n="prev">Prev</button>
                        <button class="btn btn-outline-secondary" id="btn-next" data-i18n="next">Next</button>
                    </div>
                    <div class="input-group input-group-sm" style="width: 160px;">
                        <span class="input-group-text" data-i18n="limit">Limit</span>
                        <input type="number" class="form-control" id="filter-limit" value="200" min="50" max="1000">
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-3">
            <div class="table-responsive" style="max-height: 520px; overflow: auto;">
                <table class="table table-sm table-striped sticky-head" id="patterns-table">
                    <thead>
                        <tr>
                            <th data-i18n="table_id">ID</th>
                            <th data-i18n="table_tf">TF</th>
                            <th data-i18n="table_horizon">H</th>
                            <th data-i18n="table_samples">N</th>
                            <th data-i18n="table_cred">Cred</th>
                            <th data-i18n="table_dir_acc">DirAcc</th>
                            <th data-i18n="table_misdirection">Misdirect</th>
                            <th data-i18n="table_status">Status</th>
                            <th data-i18n="table_contrarian">C</th>
                            <th data-i18n="table_last_seen">Last</th>
                            <th data-i18n="table_ring">Ring</th>
                            <th data-i18n="table_extremes">Ext</th>
                            <th data-i18n="table_actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="card p-3" id="detail-card" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0"><span data-i18n="detail_title">Pattern Detail</span>: <span class="pattern-id" id="detail-id">--</span></h5>
                <div class="d-flex align-items-center gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="detail-vectors">
                        <label class="form-check-label" for="detail-vectors" data-i18n="include_vectors">Include vectors</label>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" id="detail-refresh" data-i18n="refresh">Refresh</button>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="card p-2 h-100">
                        <h6 class="text-muted mb-2" data-i18n="detail_meta">Meta</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-compact mb-0" id="detail-meta-table">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card p-2 h-100">
                        <h6 class="text-muted mb-2" data-i18n="detail_stats">Stats</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-compact mb-0" id="detail-stats-table">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6 class="text-muted mb-2" data-i18n="detail_recent">Recent Decisions</h6>
                <div class="table-responsive" style="max-height: 260px; overflow: auto;">
                    <table class="table table-sm table-striped sticky-head" id="detail-ring-table">
                        <thead>
                            <tr>
                                <th data-i18n="detail_time">Time</th>
                                <th data-i18n="detail_pred">Pred</th>
                                <th data-i18n="detail_actual">Actual</th>
                                <th data-i18n="detail_conf">Conf</th>
                                <th data-i18n="detail_reward">Reward</th>
                                <th data-i18n="detail_margin">Margin</th>
                                <th data-i18n="detail_flags">Flags</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-lg-6">
                    <h6 class="text-muted mb-2" data-i18n="detail_extremes_best">Best Extremes</h6>
                    <div class="table-responsive" style="max-height: 220px; overflow: auto;">
                        <table class="table table-sm table-striped sticky-head" id="detail-best-table">
                            <thead>
                                <tr>
                                    <th data-i18n="detail_reward">Reward</th>
                                    <th data-i18n="detail_pred">Pred</th>
                                    <th data-i18n="detail_actual">Actual</th>
                                    <th data-i18n="detail_conf">Conf</th>
                                    <th data-i18n="detail_margin">Margin</th>
                                    <th data-i18n="detail_vectors">Vec</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h6 class="text-muted mb-2" data-i18n="detail_extremes_worst">Worst Extremes</h6>
                    <div class="table-responsive" style="max-height: 220px; overflow: auto;">
                        <table class="table table-sm table-striped sticky-head" id="detail-worst-table">
                            <thead>
                                <tr>
                                    <th data-i18n="detail_reward">Reward</th>
                                    <th data-i18n="detail_pred">Pred</th>
                                    <th data-i18n="detail_actual">Actual</th>
                                    <th data-i18n="detail_conf">Conf</th>
                                    <th data-i18n="detail_margin">Margin</th>
                                    <th data-i18n="detail_vectors">Vec</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detail-json" aria-expanded="false" data-i18n="show_raw_json">
                    Show Raw JSON
                </button>
                <div class="collapse mt-2" id="detail-json">
                    <div class="card card-body bg-light">
                        <pre class="json-box mb-0" id="detail-json-box"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const LANG_KEY = 'titan_ui_lang';
        const API_LIST = '/api/patterns/list';
        const API_DETAIL = '/api/patterns/detail';
        const CONFIG_URL = '/api/config';
        const AUTO_REFRESH_INTERVAL = 5000;

        const I18N = {
            en: {
                title: 'Patterns Overview',
                brand: 'Pattern Monitor',
                nav_dashboard: 'Dashboard',
                nav_models: 'Models',
                nav_inputs: 'Inputs',
                status_connected: 'Connected',
                status_disconnected: 'Disconnected',
                auto_refresh: 'Auto-refresh (5s)',
                filter_status: 'Status',
                filter_timeframe: 'Timeframe',
                filter_horizon: 'Horizon',
                filter_contrarian: 'Contrarian',
                filter_sort: 'Sort',
                filter_search: 'Pattern ID',
                filter_all: 'All',
                yes: 'Yes',
                no: 'No',
                sort_n: 'Samples',
                sort_credibility: 'Credibility',
                sort_dir_acc: 'Dir Accuracy',
                sort_last_seen: 'Last Seen',
                sort_misdirection: 'Misdirection',
                sort_ring: 'Ring Count',
                prev: 'Prev',
                next: 'Next',
                limit: 'Limit',
                table_id: 'ID',
                table_tf: 'TF',
                table_horizon: 'H',
                table_samples: 'N',
                table_cred: 'Cred',
                table_dir_acc: 'DirAcc',
                table_misdirection: 'Misdirect',
                table_status: 'Status',
                table_contrarian: 'C',
                table_last_seen: 'Last',
                table_ring: 'Ring',
                table_extremes: 'Ext',
                table_actions: 'Actions',
                view: 'View',
                detail_title: 'Pattern Detail',
                include_vectors: 'Include vectors',
                refresh: 'Refresh',
                detail_meta: 'Meta',
                detail_stats: 'Stats',
                detail_recent: 'Recent Decisions',
                detail_time: 'Time',
                detail_pred: 'Pred',
                detail_actual: 'Actual',
                detail_conf: 'Conf',
                detail_reward: 'Reward',
                detail_margin: 'Margin',
                detail_flags: 'Flags',
                detail_vectors: 'Vec',
                detail_extremes_best: 'Best Extremes',
                detail_extremes_worst: 'Worst Extremes',
                show_raw_json: 'Show Raw JSON',
                no_data: 'No data',
                meta_created: 'Created',
                meta_last_seen: 'Last seen',
                meta_status: 'Status',
                meta_contrarian: 'Contrarian',
                meta_timeframe: 'Timeframe',
                meta_horizon: 'Horizon',
                meta_regime: 'Regime',
                meta_ring: 'Ring',
                meta_agg: 'Aggregates',
                meta_mean: 'Mean vector',
                meta_counts: 'Counts',
                meta_hashes: 'Hashes',
                stat_p_up: 'P_up',
                stat_p_down: 'P_down',
                stat_p_flat: 'P_flat',
                stat_credibility: 'Credibility',
                stat_decay: 'Decay',
                stat_cooldown: 'Cooldown',
                stat_samples: 'Samples',
                list_meta: 'Total {total} | Offset {offset} | Limit {limit}',
            },
            ru: {
                title: 'Обзор паттернов',
                brand: 'Монитор паттернов',
                nav_dashboard: 'Дашборд',
                nav_models: 'Модели',
                nav_inputs: 'Входы',
                status_connected: 'Подключено',
                status_disconnected: 'Нет связи',
                auto_refresh: 'Авто-обновление (5с)',
                filter_status: 'Статус',
                filter_timeframe: 'Таймфрейм',
                filter_horizon: 'Горизонт',
                filter_contrarian: 'Контртренд',
                filter_sort: 'Сортировка',
                filter_search: 'ID паттерна',
                filter_all: 'Все',
                yes: 'Да',
                no: 'Нет',
                sort_n: 'Сэмплы',
                sort_credibility: 'Доверие',
                sort_dir_acc: 'Точн. напр.',
                sort_last_seen: 'Последнее',
                sort_misdirection: 'Ошибки напр.',
                sort_ring: 'Буфер',
                prev: 'Назад',
                next: 'Вперед',
                limit: 'Лимит',
                table_id: 'ID',
                table_tf: 'ТФ',
                table_horizon: 'H',
                table_samples: 'N',
                table_cred: 'Доверие',
                table_dir_acc: 'Точн. напр.',
                table_misdirection: 'Ош. напр.',
                table_status: 'Статус',
                table_contrarian: 'C',
                table_last_seen: 'Последн.',
                table_ring: 'Буфер',
                table_extremes: 'Экстр.',
                table_actions: 'Действия',
                view: 'Открыть',
                detail_title: 'Детали паттерна',
                include_vectors: 'Включить вектора',
                refresh: 'Обновить',
                detail_meta: 'Мета',
                detail_stats: 'Статистика',
                detail_recent: 'Последние решения',
                detail_time: 'Время',
                detail_pred: 'Прогноз',
                detail_actual: 'Факт',
                detail_conf: 'Увер.',
                detail_reward: 'Награда',
                detail_margin: 'Ампл.',
                detail_flags: 'Флаги',
                detail_vectors: 'Вект',
                detail_extremes_best: 'Лучшие экстремумы',
                detail_extremes_worst: 'Худшие экстремумы',
                show_raw_json: 'Показать JSON',
                no_data: 'Нет данных',
                meta_created: 'Создан',
                meta_last_seen: 'Последнее',
                meta_status: 'Статус',
                meta_contrarian: 'Контртренд',
                meta_timeframe: 'Таймфрейм',
                meta_horizon: 'Горизонт',
                meta_regime: 'Режим',
                meta_ring: 'Буфер',
                meta_agg: 'Агрегаты',
                meta_mean: 'Средний вектор',
                meta_counts: 'Счётчики',
                meta_hashes: 'Хэши',
                stat_p_up: 'P_up',
                stat_p_down: 'P_down',
                stat_p_flat: 'P_flat',
                stat_credibility: 'Доверие',
                stat_decay: 'Decay',
                stat_cooldown: 'Cooldown',
                stat_samples: 'Сэмплы',
                list_meta: 'Всего {total} | Смещение {offset} | Лимит {limit}',
            }
        };

        let currentLang = null;
        let refreshTimer = null;
        let listOffset = 0;
        let listTotal = 0;
        let currentDetailId = null;
        let horizonOptions = [];
        function detectLang() {
            const saved = localStorage.getItem(LANG_KEY);
            if (saved) return saved;
            const browserLang = (navigator.language || '').toLowerCase();
            return browserLang.startsWith('ru') ? 'ru' : 'en';
        }

        function t(key, vars) {
            const dict = I18N[currentLang] || I18N.en;
            let text = dict[key] || I18N.en[key] || key;
            if (vars) {
                Object.keys(vars).forEach((k) => {
                    text = text.replace(new RegExp(`\\{${k}\\}`, 'g'), String(vars[k]));
                });
            }
            return text;
        }

        function applyTranslations(root = document) {
            root.querySelectorAll('[data-i18n]').forEach((el) => {
                el.textContent = t(el.dataset.i18n);
            });
        }

        function setLanguage(lang) {
            currentLang = I18N[lang] ? lang : 'en';
            localStorage.setItem(LANG_KEY, currentLang);
            document.documentElement.lang = currentLang;
            document.title = t('title');
            applyTranslations();
        }

        function setConnectionStatus(ok) {
            const el = document.getElementById('connection-status');
            if (!el) return;
            if (ok) {
                el.innerHTML = `<span class="badge bg-success">${t('status_connected')}</span>`;
            } else {
                el.innerHTML = `<span class="badge bg-danger">${t('status_disconnected')}</span>`;
            }
        }

        function formatPercent(value, digits = 1) {
            if (value === null || value === undefined || Number.isNaN(value)) return '--';
            return (value * 100).toFixed(digits) + '%';
        }

        function formatTimeMs(tsMs) {
            if (!tsMs) return '--';
            const date = new Date(tsMs);
            if (Number.isNaN(date.getTime())) return '--';
            return date.toLocaleString(undefined, { hour12: false });
        }

        async function loadConfig() {
            try {
                const response = await fetch(CONFIG_URL, { cache: 'no-store' });
                if (!response.ok) return;
                const payload = await response.json();
                if (payload && Array.isArray(payload.horizons)) {
                    horizonOptions = payload.horizons.slice().sort((a, b) => a - b);
                }
            } catch (error) {
                // ignore
            }
            const horizonSelect = document.getElementById('filter-horizon');
            if (horizonSelect && horizonOptions.length) {
                horizonSelect.innerHTML = `<option value="">${t('filter_all')}</option>` + horizonOptions
                    .map((h) => `<option value="${h}">${h}m</option>`)
                    .join('');
            }
        }

        function buildQuery() {
            const params = new URLSearchParams();
            const limit = Math.max(50, Number(document.getElementById('filter-limit').value || 200));
            params.set('limit', String(limit));
            params.set('offset', String(listOffset));
            params.set('sort_by', document.getElementById('filter-sort').value);
            params.set('order', 'desc');

            const status = document.getElementById('filter-status').value;
            if (status) params.set('status', status);
            const timeframe = document.getElementById('filter-timeframe').value;
            if (timeframe) params.set('timeframe', timeframe);
            const horizon = document.getElementById('filter-horizon').value;
            if (horizon) params.set('horizon', horizon);
            const contrarian = document.getElementById('filter-contrarian').value;
            if (contrarian) params.set('contrarian', contrarian);
            const search = document.getElementById('filter-search').value.trim();
            if (search) params.set('search', search);
            return params;
        }

        function renderListMeta(total, offset, limit) {
            const el = document.getElementById('list-meta');
            if (!el) return;
            el.textContent = t('list_meta', { total, offset, limit });
        }
        function renderTableRows(patterns) {
            const tbody = document.querySelector('#patterns-table tbody');
            tbody.innerHTML = '';
            if (!patterns.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="13" class="text-muted">${t('no_data')}</td>`;
                tbody.appendChild(tr);
                return;
            }
            patterns.forEach((p) => {
                const tr = document.createElement('tr');
                const shortId = p.pattern_id.slice(0, 8);
                tr.innerHTML = `
                    <td class="pattern-id" title="${p.pattern_id}">${shortId}</td>
                    <td>${p.timeframe}</td>
                    <td>${p.horizon}m</td>
                    <td>${p.n}</td>
                    <td>${formatPercent(p.credibility, 0)}</td>
                    <td>${p.dir_accuracy === null ? '--' : formatPercent(p.dir_accuracy, 1)}</td>
                    <td>${formatPercent(p.misdirection_rate, 1)}</td>
                    <td><span class="badge bg-light text-dark border badge-status">${p.status}</span></td>
                    <td>${p.contrarian ? 'Y' : ''}</td>
                    <td>${formatTimeMs(p.last_seen_ms)}</td>
                    <td>${p.ring_count}/${p.ring_capacity}</td>
                    <td>${p.extremes_best}/${p.extremes_worst}</td>
                    <td><button class="btn btn-outline-primary btn-sm" data-pattern-id="${p.pattern_id}">${t('view')}</button></td>
                `;
                tr.querySelector('button')?.addEventListener('click', () => fetchDetail(p.pattern_id));
                tbody.appendChild(tr);
            });
        }

        async function fetchList() {
            try {
                const response = await fetch(`${API_LIST}?${buildQuery().toString()}`, { cache: 'no-store' });
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                setConnectionStatus(true);
                listTotal = data.total || 0;
                renderListMeta(listTotal, data.offset || 0, data.limit || 0);
                renderTableRows(data.patterns || []);
            } catch (error) {
                console.error('Error fetching patterns list:', error);
                setConnectionStatus(false);
            }
        }

        function renderKeyValueTable(tableId, rows) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';
            rows.forEach(([label, value]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-muted">${label}</td><td>${value}</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderRecordTable(tableId, rows) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!rows.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" class="text-muted">${t('no_data')}</td>`;
                tbody.appendChild(tr);
                return;
            }
            rows.forEach((r) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatTimeMs(r.ts_ms)}</td>
                    <td>${r.pred_label || '--'}</td>
                    <td>${r.actual_label || '--'}</td>
                    <td>${formatPercent(r.confidence, 1)}</td>
                    <td>${r.reward.toFixed(3)}</td>
                    <td>${r.outcome_margin.toFixed(3)}</td>
                    <td>${r.flags}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderExtremes(tableId, rows) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!rows.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" class="text-muted">${t('no_data')}</td>`;
                tbody.appendChild(tr);
                return;
            }
            rows.forEach((item) => {
                const record = item.record || {};
                const tr = document.createElement('tr');
                const hasVec = item.feature_vector ? 'Y' : '';
                tr.innerHTML = `
                    <td>${item.reward.toFixed(3)}</td>
                    <td>${record.pred_label || '--'}</td>
                    <td>${record.actual_label || '--'}</td>
                    <td>${formatPercent(record.confidence, 1)}</td>
                    <td>${record.outcome_margin?.toFixed ? record.outcome_margin.toFixed(3) : '--'}</td>
                    <td>${hasVec}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function fetchDetail(patternId) {
            if (!patternId) return;
            currentDetailId = patternId;
            const includeVectors = document.getElementById('detail-vectors').checked;
            const params = new URLSearchParams({
                pattern_id: patternId,
                ring_limit: '200',
                extremes_limit: '20',
                include_vectors: includeVectors ? 'true' : 'false',
            });
            try {
                const response = await fetch(`${API_DETAIL}?${params.toString()}`, { cache: 'no-store' });
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                document.getElementById('detail-card').style.display = 'block';
                document.getElementById('detail-id').textContent = data.pattern_id || patternId;
                document.getElementById('detail-json-box').textContent = JSON.stringify(data, null, 2);

                const meta = data.meta || {};
                const metaRows = [
                    [t('meta_status'), meta.status || '--'],
                    [t('meta_contrarian'), meta.contrarian ? 'Y' : 'N'],
                    [t('meta_timeframe'), meta.timeframe || '--'],
                    [t('meta_horizon'), meta.horizon ? `${meta.horizon}m` : '--'],
                    [t('meta_created'), formatTimeMs(meta.created_at_ms)],
                    [t('meta_last_seen'), formatTimeMs(meta.last_seen_ms)],
                    [t('meta_regime'), meta.regime_key ?? '--'],
                    [t('meta_ring'), `${meta.ring_count ?? 0}/${meta.ring_capacity ?? 0}`],
                    [t('meta_agg'), meta.agg_count ?? 0],
                    [t('meta_mean'), `${meta.mean_count ?? 0} / ${meta.mean_dim ?? 0}`],
                    [t('meta_counts'), `ok:${meta.correct_count ?? 0} bad:${meta.wrong_count ?? 0} mis:${meta.misdirection_count ?? 0} cw:${meta.confident_wrong_count ?? 0}`],
                    [t('meta_hashes'), `${(meta.market_hash || '').slice(0, 8)}... / ${(meta.context_hash || '').slice(0, 8)}...`],
                ];
                renderKeyValueTable('detail-meta-table', metaRows);

                const stats = data.stats || {};
                const statsRows = [
                    [t('stat_samples'), stats.n ?? '--'],
                    [t('stat_p_up'), stats.p_up_mem !== undefined ? formatPercent(stats.p_up_mem, 1) : '--'],
                    [t('stat_p_down'), stats.p_down_mem !== undefined ? formatPercent(stats.p_down_mem, 1) : '--'],
                    [t('stat_p_flat'), stats.p_flat_mem !== undefined ? formatPercent(stats.p_flat_mem, 1) : '--'],
                    [t('stat_credibility'), stats.credibility !== undefined ? formatPercent(stats.credibility, 1) : '--'],
                    [t('stat_decay'), stats.decay_factor !== undefined ? stats.decay_factor.toFixed(3) : '--'],
                    [t('stat_cooldown'), stats.is_in_cooldown ? 'Y' : 'N'],
                ];
                renderKeyValueTable('detail-stats-table', statsRows);

                renderRecordTable('detail-ring-table', data.ring_records || []);
                renderExtremes('detail-best-table', data.extremes_best || []);
                renderExtremes('detail-worst-table', data.extremes_worst || []);
            } catch (error) {
                console.error('Error fetching pattern detail:', error);
                setConnectionStatus(false);
            }
        }

        function startTimer() {
            if (refreshTimer) clearInterval(refreshTimer);
            fetchList();
            refreshTimer = setInterval(fetchList, AUTO_REFRESH_INTERVAL);
        }

        document.getElementById('btn-prev').addEventListener('click', () => {
            const limit = Math.max(50, Number(document.getElementById('filter-limit').value || 200));
            listOffset = Math.max(0, listOffset - limit);
            fetchList();
        });

        document.getElementById('btn-next').addEventListener('click', () => {
            const limit = Math.max(50, Number(document.getElementById('filter-limit').value || 200));
            listOffset = Math.min(listTotal, listOffset + limit);
            fetchList();
        });

        document.getElementById('detail-refresh').addEventListener('click', () => {
            if (currentDetailId) {
                fetchDetail(currentDetailId);
            }
        });

        ['filter-status','filter-timeframe','filter-horizon','filter-contrarian','filter-sort','filter-search','filter-limit']
            .forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        listOffset = 0;
                        fetchList();
                    });
                }
            });

        const checkbox = document.getElementById('autoRefresh');
        checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                startTimer();
            } else {
                clearInterval(refreshTimer);
            }
        });

        const langSelect = document.getElementById('lang-select');
        currentLang = detectLang();
        if (langSelect) {
            langSelect.value = currentLang;
            langSelect.addEventListener('change', (e) => {
                setLanguage(e.target.value);
                loadConfig().finally(fetchList);
            });
        }
        setLanguage(currentLang);
        loadConfig().finally(startTimer);
    </script>
</body>
</html>
